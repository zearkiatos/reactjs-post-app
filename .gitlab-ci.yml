image: docker:latest
variables:
  DOCKER_DRIVER: overlay
  CRYPTOGRAPHY_DONT_BUILD_RUST: 1
services:
  - docker:dind


stages:
  - install
  - build

install-dependencies:
  stage: install
  script:
    - docker info
    - apk update
    - apk upgrade
    - apk add curl jq python3 python3-dev build-base libffi-dev libressl-dev gettext
    - curl -O https://bootstrap.pypa.io/get-pip.py
    - python3 get-pip.py
    - pip install --upgrade pip
    - pip install docker-compose


build-app:
  stage: build
  variables:
    ENVIRONMENT: 'staging'
  dependencies:
    - install-dependencies
  script:
    - docker-compose up -d
  only:
    - branches